<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CYM 2025 Leader Tracker</title>
  <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script defer>
    const firebaseConfig = {
      apiKey: "AIzaSyBxerHpUJgqIy6pSw2dAKuqrFVdO9Wznwo",
      authDomain: "data-f1e07.firebaseapp.com",
      projectId: "data-f1e07",
      storageBucket: "data-f1e07.firebasestorage.app",
      messagingSenderId: "544766634870",
      appId: "1:544766634870:web:7ad7c96953cf450eaee857",
      measurementId: "G-072SX0TV3B"
    };

    window.addEventListener('DOMContentLoaded', async () => {
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      const adminEmail = "admin@qc.com";
      const adminPassword = "qcadmin";

      const meetings = ["W12 MEETING", "W12 DISCIPLESHIP", "CELL GROUP", "SUNDAY SERVICE", "CYM NIGHT", "THURSDAY TRAINING", "PRAYER MEETING"];
      const weeks = ["1st week", "2nd week", "3rd week", "4th week", "5th week"];
      const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

      let currentUser = null;
      let selectedMonth = 0;

      function renderMonthButtons() {
        const mb = document.getElementById("month-buttons");
        months.forEach((m, i) => {
          const btn = document.createElement("button");
          btn.textContent = m;
          btn.onclick = () => {
            loadMonth(i);
            generateCalendar(i);
          };
          mb.appendChild(btn);
        });
      }

      async function loadMonth(monthIndex) {
        selectedMonth = monthIndex;
        document.getElementById("month-title").textContent = months[monthIndex];
        const grid = document.getElementById("attendance-grid");
        grid.innerHTML = "";

        const docRef = db.collection("users").doc(currentUser.uid);
        const docSnap = await docRef.get();
        const data = docSnap.exists ? docSnap.data() : {};
        const attendance = data.attendance?.[monthIndex] || {};

        meetings.forEach(meeting => {
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = meeting;
          grid.appendChild(label);

          const weekRow = document.createElement("div");
          weekRow.className = "week-row";

          weeks.forEach((_, weekIndex) => {
            const btn = document.createElement("button");
            const key = `${meeting}_${weekIndex}`;
            const state = attendance[key] || "NM";
            btn.textContent = state;
            btn.className = state;

            btn.onclick = async function () {
              const states = ["NM", "P", "A"];
              let idx = states.indexOf(btn.className);
              idx = (idx + 1) % states.length;
              const next = states[idx];
              btn.textContent = next;
              btn.className = next;
              await saveAttendance(monthIndex, key, next);
            };

            weekRow.appendChild(btn);
          });

          grid.appendChild(weekRow);
        });
      }

      async function saveAttendance(month, key, value) {
        const adminRef = db.collection("users").doc(adminEmail);
        const adminSnap = await adminRef.get();
        const existing = adminSnap.exists ? adminSnap.data().attendance || {} : {};
        const updated = {
          ...existing,
          [month]: {
            ...(existing[month] || {}),
            [`${currentUser.email}_${key}`]: value
          }
        };
        await adminRef.set({ attendance: updated }, { merge: true });
      }

      async function generateCalendar(monthIndex) {
        const calendar = document.getElementById("calendar");
        calendar.innerHTML = "";
        const daysInMonth = new Date(2025, monthIndex + 1, 0).getDate();

        const docSnap = await db.collection("users").doc(currentUser.uid).get();
        const calData = docSnap.exists ? docSnap.data().calendar || {} : {};

        for (let d = 1; d <= daysInMonth; d++) {
          const box = document.createElement("div");
          box.className = "day";
          const id = `day_${monthIndex}_${d}`;
          box.innerHTML = `${d}<br><input type='checkbox' id='${id}' />`;
          const checkbox = box.querySelector("input");
          checkbox.checked = !!calData[id];

          checkbox.addEventListener("change", async () => {
            const userRef = db.collection("users").doc(currentUser.uid);
            const snap = await userRef.get();
            const existing = snap.exists ? snap.data().calendar || {} : {};
            const updated = {
              ...existing,
              [id]: checkbox.checked
            };
            await userRef.set({ calendar: updated }, { merge: true });
          });

          calendar.appendChild(box);
        }
      }

      window.login = function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.signInWithEmailAndPassword(email, password)
          .then(() => location.reload())
          .catch(e => alert(e.message));
      }

      window.register = function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.createUserWithEmailAndPassword(email, password)
          .then(() => location.reload())
          .catch(e => alert(e.message));
      }

      window.logout = function () {
        auth.signOut().then(() => location.reload());
      }

      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          document.getElementById("auth-box").classList.add("hidden");
          document.getElementById("app").classList.remove("hidden");
          document.getElementById("userEmail").textContent = user.email;
          renderMonthButtons();
          loadMonth(0);
          generateCalendar(0);
        }
      });
    });
  </script>
  <style>
    body { font-family: Arial; background: #ddd; margin: 0; padding: 0; }
    header { background: #111; color: #fff; padding: 15px; text-align: center; }
    .container { padding: 20px; }
    .hidden { display: none; }
    .auth-box { background: #fff; padding: 20px; margin: 20px auto; width: 300px; border-radius: 10px; }
    .month-buttons button { margin: 2px; padding: 5px 10px; }
    .attendance-grid { margin-top: 10px; }
    .attendance-grid .label { margin: 10px 0 5px; font-weight: bold; }
    .attendance-grid .week-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .attendance-grid button { flex: 1; padding: 8px; border: none; cursor: pointer; color: white; background: #888; }
    .attendance-grid button.P { background: #4CAF50; }
    .attendance-grid button.A { background: #f44336; }
    .attendance-grid button.NM { background: #999; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
    .day { background: white; padding: 10px; border: 1px solid #ccc; text-align: center; }
    .legend { font-size: 0.9em; margin: 5px 0 15px; }
  </style>
</head>
<body>
  <header><h2>CYM 2025 Leader Tracker</h2></header>
  <div class="auth-box" id="auth-box">
    <h3>Login / Register</h3>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
  </div>
  <div class="container hidden" id="app">
    <p>Welcome, <span id="userEmail"></span> <button onclick="logout()">Logout</button></p>
    <div class="month-buttons" id="month-buttons"></div>
    <h3 id="month-title"></h3>
    <div class="legend">
      <strong>Legend:</strong> <span style="color: green;">Green</span> = Present,
      <span style="color: red;">Red</span> = Absent,
      <span style="color: gray;">Gray</span> = No Meeting
    </div>
    <div class="attendance-grid" id="attendance-grid"></div>
    <div class="calendar" id="calendar"></div>
  </div>
</body>
</html>
