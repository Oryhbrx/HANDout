<!-- CYM Leader Tracker Merged Version -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CYM Leader Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background: #222;
      color: white;
      padding: 1em;
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1em;
    }
    .section {
      background: white;
      padding: 1em;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .month-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 1em;
    }
    .month-selector button {
      padding: 0.5em 1em;
      border: none;
      background: #ccc;
      cursor: pointer;
    }
    .month-selector button.active {
      background: #4CAF50;
      color: white;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 1em;
    }
    .calendar div {
      background: #fff;
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
      font-size: 14px;
    }
    .calendar input[type="checkbox"] {
      margin-top: 5px;
    }
    .attendance-section {
      margin-top: 2em;
    }
    .attendance-section label {
      font-weight: bold;
      display: block;
      margin-top: 1em;
    }
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      margin-top: 0.5em;
    }
    .attendance-grid button {
      padding: 0.4em;
      background: #eee;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .attendance-grid button.P { background: #4CAF50; color: white; }
    .attendance-grid button.A { background: #f44336; color: white; }
    .attendance-grid button.NM { background: #999; color: white; }
    #logoutBtn { margin-top: 10px; }
  </style>
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>CYM 2025 Leader Tracker</h1>
    <div id="user-info"></div>
  </header>

  <div class="container">
    <div id="authSection" class="section">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <select id="role">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <button onclick="signup()">Sign Up</button>
      <button onclick="login()">Login</button>
    </div>

    <div id="userSection" class="section hidden">
      <label><strong>Insert Name:</strong></label>
      <input type="text" id="username" placeholder="Type your full name..." />
      <div class="month-selector" id="month-selector"></div>
      <h2 id="month-title">January</h2>
      <h3>DEVOTION: <span id='devotion-count'>0</span> days checked</h3>
      <div id="calendar" class="calendar"></div>
      <div class="attendance-section" id="attendance-forms"></div>
    </div>

    <div id="adminSection" class="section hidden">
      <h3>Admin Dashboard</h3>
      <div id="allUserData"></div>
    </div>

    <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyANOp3tzEMmvPzcysdu7wEQd-kCqmi1WgY",
      authDomain: "webhandouts-e0a35.firebaseapp.com",
      projectId: "webhandouts-e0a35",
      storageBucket: "webhandouts-e0a35.appspot.com",
      messagingSenderId: "284574980946",
      appId: "1:284574980946:web:30903fcbb5dcb6e1ad388b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const sections = ["W12 MEETING","W12 DISCIPLESHIP","CELL GROUP","SUNDAY SERVICE","CYM NIGHT","THURSDAY TRAINING","PRAYER MEETING"];
    const daysInMonth = (m, y) => new Date(y, m + 1, 0).getDate();

    let currentMonth = 0;

    function renderMonthButtons() {
      const container = document.getElementById("month-selector");
      container.innerHTML = "";
      months.forEach((m, i) => {
        const btn = document.createElement("button");
        btn.textContent = m;
        btn.classList.toggle("active", i === 0);
        btn.onclick = () => {
          currentMonth = i;
          [...document.querySelectorAll(".month-selector button")].forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          renderCalendar();
          renderAttendance();
        };
        container.appendChild(btn);
      });
    }

    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById("authSection").classList.add("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");

        const doc = await db.collection("users").doc(user.uid).get();
        const role = doc.data()?.role;

        if (role === "admin") {
          document.getElementById("adminSection").classList.remove("hidden");
          loadAllUserData();
        } else {
          document.getElementById("userSection").classList.remove("hidden");
          renderMonthButtons();
          renderCalendar();
          renderAttendance();
        }
      } else {
        document.getElementById("authSection").classList.remove("hidden");
        document.getElementById("userSection").classList.add("hidden");
        document.getElementById("adminSection").classList.add("hidden");
        document.getElementById("logoutBtn").classList.add("hidden");
      }
    });

    async function signup() {
      const email = email.value;
      const password = password.value;
      const roleVal = role.value;
      const userCred = await auth.createUserWithEmailAndPassword(email, password);
      await db.collection("users").doc(userCred.user.uid).set({ email, role: roleVal });
      alert("Signup successful!");
    }

    async function login() {
      await auth.signInWithEmailAndPassword(email.value, password.value);
    }

    function logout() {
      auth.signOut();
    }

    function updateDevotionCount(devotions) {
      document.getElementById("devotion-count").textContent = devotions.size;
    }

    async function renderCalendar() {
      const uid = auth.currentUser.uid;
      const member = document.getElementById("username").value.trim();
      if (!member) return;

      const month = currentMonth;
      const year = 2025;
      const days = daysInMonth(month, year);
      monthTitle.textContent = months[month];
      const docId = `${uid}_${member}_${year}-${String(month+1).padStart(2, '0')}`;
      const ref = db.collection("tracker").doc(docId);
      let snap = await ref.get();
      if (!snap.exists) await ref.set({ devotions: [], attendance: {} });
      const data = snap.data
